#!/usr/bin/make -f

#export DH_VERBOSE=1

VERSION	:= $(shell dpkg-parsechangelog | sed -nr '/^Version:/s/Version: (.*:)?(.*)-(.*)/\2/p')
DESTDIR	= $(CURDIR)/debian/displaylink
DEBIAN_VERSION := $(shell lsb_release -c)
ifneq (,$(findstring $(DEB_HOST_ARCH), amd64))
  SOURCE_DL_DIR=x64-ubuntu-1604
else ifneq (,$(findstring $(DEB_HOST_ARCH), armhf))
  SOURCE_DL_DIR=arm-linux-gnueabihf
else
  SOURCE_DL_DIR=x86-ubuntu-1604
endif
ifeq ($(DEBIAN_VERSION), buster)
  XORG_FILE=20-displaylink.conf
else
  XORG_FILE=20-displaylink-old.conf
endif

%:
	dh $@ --with systemd

override_dh_auto_clean:
	rm -f displaylink-sleep

override_dh_auto_build:
	bash debian/displaylink-sleep-extractor.sh displaylink-installer.sh > displaylink-sleep

override_dh_auto_install:
	# firmware
	install -D -m 644 -t "$(DESTDIR)/opt/displaylink" *.spkg
	# Binary
	install -D -m 755 $(SOURCE_DL_DIR)/DisplayLinkManager "$(DESTDIR)/opt/displaylink/DisplayLinkManager"
	# Sleep/resume script
	install -D -m 755 displaylink-sleep "$(DESTDIR)/lib/systemd/system-sleep/displaylink" 
	# Xorg config file
	install -D -m 644 "debian/$(XORG_FILE)" "$(DESTDIR)/usr/share/X11/xorg.conf.d/20-displaylink.conf" 
	# Apparmor
	install -D -m 644 debian/opt.displaylink.DisplayLinkManager $(DESTDIR)/etc/apparmor.d/opt.displaylink.DisplayLinkManager
	dh_apparmor --profile-name=opt.displaylink.DisplayLinkManager -pdisplaylink

override_dh_systemd_start:
	dh_systemd_start --no-start

override_dh_systemd_enable:
	dh_systemd_enable --no-enable

override_dh_strip:
	patchelf --remove-rpath "$(DESTDIR)/opt/displaylink/DisplayLinkManager"
	dh_strip

# do nothing
override_dh_auto_configure:
override_dh_auto_test:
